From dd6c33d372f3b83f4fe57904c2bd5ebba5c38018 Mon Sep 17 00:00:00 2001
From: drh <drh@noemail.net>
Date: Sat, 23 May 2020 19:58:07 +0000
Subject: [PATCH] Limit the "precision" of floating-point to text conversions
 in the printf() function to 100,000,000.  Fix for ticket [23439ea582241138].

FossilOrigin-Name: d08d3405878d394e08e5d3af281246edfbd81ca74cc8d16458808591512fb93d
---
 src/printf.c     | 12 ++++++++++++
 test/printf.test |  7 +++++++
 4 files changed, 27 insertions(+), 8 deletions(-)

--- sqlite3-3.27.2.orig/src/printf.c
+++ sqlite3-3.27.2/src/printf.c
@@ -187,6 +187,13 @@ static char *printfTempBuf(sqlite3_str *
 #define etBUFSIZE SQLITE_PRINT_BUF_SIZE  /* Size of the output buffer */
 
 /*
+** Hard limit on the precision of floating-point conversions.
+*/
+#ifndef SQLITE_PRINTF_PRECISION_LIMIT
+# define SQLITE_FP_PRECISION_LIMIT 100000000
+#endif
+
+/*
 ** Render a string given by "fmt" into the StrAccum object.
 */
 void sqlite3_str_vappendf(
@@ -507,6 +514,11 @@ void sqlite3_str_vappendf(
         length = 0;
 #else
         if( precision<0 ) precision = 6;         /* Set default precision */
+#ifdef SQLITE_FP_PRECISION_LIMIT
+        if( precision>SQLITE_FP_PRECISION_LIMIT ){
+          precision = SQLITE_FP_PRECISION_LIMIT;
+        }
+#endif
         if( realvalue<0.0 ){
           realvalue = -realvalue;
           prefix = '-';
--- sqlite3-3.27.2.orig/test/printf.test
+++ sqlite3-3.27.2/test/printf.test
@@ -3777,4 +3777,11 @@ foreach ::iRepeat {0 1} {
   }
 }
 
+# 2020-05-23
+# ticket 23439ea582241138
+#
+do_execsql_test printf-16.1 {
+  SELECT printf('%.*g',2147483647,0.01);
+} {0.01}
+
 finish_test
